#!/usr/bin/env python3
"""Export a LaTeX table of NTU-Fi HumanID results from SenseFi logs.

Reads all `*.log` under a given directory (default: logs/train_all/NTU-Fi-HumanID/result)
and writes a Booktabs table to `figures/ntu_fi_results/results.tex`.

Usage:
  source .venv/bin/activate
  python export_results_table.py \
      --log-dir logs/train_all/NTU-Fi-HumanID/result \
      --out figures/ntu_fi_results/results.tex
"""

from __future__ import annotations

import argparse
import pathlib
import re
from typing import Dict, List, Tuple


def parse_log(path: pathlib.Path) -> Tuple[float, float]:
    val_re = re.compile(r"validation accuracy:([0-9.]+), loss:([-0-9.eE]+)", re.IGNORECASE)
    val_acc = None
    val_loss = None
    for line in path.read_text().splitlines():
        m = val_re.search(line)
        if m:
            val_acc = float(m.group(1))
            val_loss = float(m.group(2))
    if val_acc is None or val_loss is None:
        raise ValueError(f"No validation metrics found in {path}")
    return val_acc, val_loss


def collect_results(log_dir: pathlib.Path) -> List[Tuple[str, float, float]]:
    rows: List[Tuple[str, float, float]] = []
    for log in sorted(log_dir.glob("*.log")):
        name_parts = log.stem.split("_", 1)
        model = name_parts[1] if len(name_parts) > 1 else log.stem
        try:
            acc, loss = parse_log(log)
        except ValueError:
            continue
        rows.append((model, acc, loss))
    if not rows:
        raise RuntimeError(f"No valid logs in {log_dir}")
    # Keep the best entry per model
    best: Dict[str, Tuple[float, float]] = {}
    for model, acc, loss in rows:
        if model not in best or acc > best[model][0]:
            best[model] = (acc, loss)
    merged = [(m, a, l) for m, (a, l) in best.items()]
    merged.sort(key=lambda t: t[1], reverse=True)
    return merged


def write_table(rows: List[Tuple[str, float, float]], out_path: pathlib.Path) -> None:
    out_path.parent.mkdir(parents=True, exist_ok=True)
    with out_path.open("w") as f:
        f.write("% Auto-generated by export_results_table.py\n")
        f.write("\\begin{tabular}{lrr}\n")
        f.write("\\toprule\n")
        f.write("Model & Val Acc (\\%) & Val Loss\\\\\\n")
        f.write("\\midrule\n")
        for model, acc, loss in rows:
            f.write(f"{model} & {acc*100:.1f} & {loss:.4f}\\\\\n")
        f.write("\\bottomrule\n")
        f.write("\\end{tabular}\n")


def main():
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument(
        "--log-dir",
        type=pathlib.Path,
        default=pathlib.Path("logs/train_all/NTU-Fi-HumanID/result"),
        help="Directory of SenseFi log files (*.log).",
    )
    parser.add_argument(
        "--out",
        type=pathlib.Path,
        default=pathlib.Path("figures/ntu_fi_results/results.tex"),
        help="Output LaTeX table path.",
    )
    args = parser.parse_args()

    rows = collect_results(args.log_dir)
    write_table(rows, args.out)
    print(f"Wrote {args.out} ({len(rows)} models)")


if __name__ == "__main__":
    main()

